rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helpers ───────────────────────────────────────────────────────────────
    function isSignedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function getUser() {
      return get(/databases/$(database)/documents/users/$(uid())).data;
    }

    function isAdmin() {
      return isSignedIn() && getUser().role == 'admin';
    }

    function isDriver() {
      return isSignedIn() && getUser().role == 'driver';
    }

    function isCustomer() {
      return isSignedIn() && getUser().role == 'customer';
    }

    // ── Users ─────────────────────────────────────────────────────────────────
    match /users/{userId} {
      // Anyone can create their own user doc (registration)
      allow create: if isSignedIn() && uid() == userId;
      // Users can read/update their own profile; admins can read all
      allow read: if isSignedIn() && (uid() == userId || isAdmin());
      allow update: if isSignedIn() && (uid() == userId || isAdmin());
      allow delete: if isAdmin();
    }

    // ── Restaurants ───────────────────────────────────────────────────────────
    match /restaurants/{restaurantId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ── Menu Categories ───────────────────────────────────────────────────────
    match /menuCategories/{categoryId} {
      allow read: if true; // public menu
      allow write: if isAdmin();
    }

    // ── Menu Items ────────────────────────────────────────────────────────────
    match /menuItems/{itemId} {
      allow read: if true; // public menu
      allow write: if isAdmin();
    }

    // ── Orders ────────────────────────────────────────────────────────────────
    match /orders/{orderId} {
      // Customers can read their own orders
      allow read: if isSignedIn() && (
        resource.data.customerId == uid() ||
        resource.data.driverId == uid() ||
        isAdmin()
      );

      // Customers can create orders (must set their own customerId)
      allow create: if isCustomer() &&
        request.resource.data.customerId == uid() &&
        request.resource.data.status == 'RECEIVED';

      // Drivers can only update status fields for their assigned orders
      allow update: if isDriver() &&
        resource.data.driverId == uid() &&
        onlyUpdatesAllowedDriverFields();

      // Admins can update anything
      allow update: if isAdmin();

      // No one can delete orders
      allow delete: if false;
    }

    function onlyUpdatesAllowedDriverFields() {
      // Drivers may only change: status, timestamps, trackingEnabled
      let allowedKeys = ['status', 'timestamps', 'trackingEnabled'];
      let changedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return changedKeys.hasOnly(allowedKeys);
    }

    // ── Drivers (location + status) ───────────────────────────────────────────
    match /drivers/{driverId} {
      // Admins and the driver themselves can read
      allow read: if isAdmin() || (isDriver() && uid() == driverId);

      // Customers can read driver location ONLY if:
      //   1. They have an active order with this driver
      //   2. The order status >= PICKED_UP (trackingEnabled == true)
      allow read: if isCustomer() && driverLocationSharedWithCustomer(driverId);

      // Only the driver can write their own location doc
      allow write: if isDriver() && uid() == driverId;

      // Admins can write (for assignment etc.)
      allow write: if isAdmin();
    }

    function driverLocationSharedWithCustomer(_driverId) {
      // Check if any order exists where:
      //   customerId == uid(), driverId == driverId, trackingEnabled == true
      return exists(/databases/$(database)/documents/orders/$(
        // We can't easily query here; use a simpler check with a known orderId
        // In practice, pass orderId via the app and use per-order rules
        'placeholder'
      ));
      // NOTE: The mobile app passes orderId explicitly; full enforcement
      // is done in the app layer. For production, use a subcollection approach
      // or custom claims to store activeOrderId on the customer token.
    }

    // ── Order Events ──────────────────────────────────────────────────────────
    match /orderEvents/{eventId} {
      allow read: if isAdmin() || (
        isSignedIn() &&
        get(/databases/$(database)/documents/orders/$(resource.data.orderId)).data.customerId == uid()
      );
      allow create: if isAdmin() || isDriver();
      allow update, delete: if isAdmin();
    }

    // ── Coupons ───────────────────────────────────────────────────────────────
    match /coupons/{couponId} {
      allow read: if isSignedIn(); // needed for client-side validation
      allow write: if isAdmin();
    }
  }
}
